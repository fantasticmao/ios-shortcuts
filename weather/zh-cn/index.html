<html lang="zh-cn">
<head>
    <meta charset="utf-8"/>
    <meta name="author" content="FantasticMao"/>
    <title>当前天气预报</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
</head>

<body>
<h2 id="forecast"></h2>
</body>

<script>
    $.ajax({
        url: "https://zh.wttr.in/?format=j1",
        async: false,
    }).done(function (response) {
        const data = parseResponse(JSON.parse(response));
        const text = renderText(data);
        $("#forecast").text(text);
    }).fail(function (jqXHR, textStatus, errorThrown) {
        $("#forecast").text("加载天气数据失败");
        window.console.log(textStatus);
        window.console.error(errorThrown);
    });

    function parseResponse(response) {
        const date = new Date();
        const city = response["nearest_area"][0]["areaName"][0]["value"]; // 城市
        // 当前数据
        const weatherDesc = response["current_condition"][0]["lang_zh"][0]["value"]; // 当前天气
        const humidity = response["current_condition"][0]["humidity"]; // 当前湿度
        const tempC = response["current_condition"][0]["temp_C"]; // 当前温度
        // 当日数据
        const maxTempC = response["weather"][0]["maxtempC"]; // 最高气温
        const minTempC = response["weather"][0]["mintempC"]; // 最低气温
        const uvIndex = response["weather"][0]["uvIndex"]; // 紫外线
        return new Data(date, city, weatherDesc, humidity, tempC,
            maxTempC, minTempC, uvIndex);
    }

    function renderText(data) {
        return data.year + " 年 " +
            data.month + " 月 " +
            data.day + " 日 " +
            data.city + " 当前天气" +
            data.weatherDesc + "，温度 " +
            data.tempC + " 度，相对湿度百分之 " +
            data.humidity + "。预计今日最高气温 " +
            data.maxTempC + " 度，最低气温 " +
            data.minTempC + " 度，紫外线指数 " +
            data.uvIndex + " 级。";
    }

    function Data(date, city,
                  weatherDesc, tempC, humidity,
                  maxTempC, minTempC, uvIndex, airQualityIndex, chanceOfRain) {
        return {
            year: date.getFullYear(),
            month: date.getMonth() + 1,
            day: date.getDate(),
            city: city,
            weatherDesc: weatherDesc,
            tempC: tempC,
            humidity: humidity,
            maxTempC: maxTempC,
            minTempC: minTempC,
            uvIndex: uvIndex,
            airQualityIndex: airQualityIndex,
            chanceOfRain: chanceOfRain
        };
    }
</script>
</html>
